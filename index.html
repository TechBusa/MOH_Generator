<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Document Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            --tw-bg-navy: #1E3A8A; /* blue-800 */
            --tw-text-navy: #111827; /* gray-900 */
            --tw-bg-orange: #F97316; /* orange-500 */
            --tw-bg-orange-hover: #EA580C; /* orange-600 */
        }

        .form-section {
            display: none;
        }

            .form-section.active {
                display: block;
            }

        .table-input-row input {
            width: 100%;
        }

        .btn-primary {
            background-color: var(--tw-bg-orange);
        }

            .btn-primary:hover {
                background-color: var(--tw-bg-orange-hover);
            }

        .text-navy {
            color: var(--tw-text-navy);
        }

        .border-navy {
            border-color: var(--tw-bg-navy);
        }

        .focus-ring-orange:focus {
            --tw-ring-color: var(--tw-bg-orange);
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }

        input:read-only {
            background-color: #f3f4f6; /* gray-100 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <h1 class="text-3xl font-bold text-center mb-4 text-navy">PDF Document Generator</h1>
            <p class="text-center text-gray-500 mb-8">Select a document type, fill in the fields, and generate your PDF.</p>

            <!-- Settings Section -->
            <div class="bg-gray-50 p-6 rounded-lg mb-8 border border-gray-200">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-navy">Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="logo-upload" class="block text-sm font-medium text-gray-700 mb-2">Company Logo:</label>
                        <input type="file" id="logo-upload" accept="image/png" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <img id="logo-preview" src="https://placehold.co/150x60/eee/ccc?text=Upload+Logo" alt="Logo Preview" class="mt-2 rounded-md border p-2 h-20 object-contain">
                        <button id="save-logo" class="mt-2 w-full btn-primary text-white py-2 px-4 rounded-md transition duration-150 ease-in-out">Save Logo</button>
                    </div>
                    <div class="text-sm text-gray-600 bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-navy mb-2">Company Info</h3>
                        <p>Your company letterhead and banking details are now hardcoded into the generator.</p>
                        <p class="mt-4">You only need to upload and save your company logo once.</p>
                    </div>
                </div>
            </div>

            <!-- Document Selection -->
            <div class="mb-8">
                <label for="doc-type" class="block text-sm font-medium text-gray-700 mb-2">Select Document Type:</label>
                <select id="doc-type" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                    <option value="packing-list">Packing List</option>
                    <option value="conformance-cert">Certificate of Conformance</option>
                </select>
            </div>

            <!-- Packing List Form -->
            <div id="packing-list-form" class="form-section active">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3 text-navy">Packing List Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="text" id="pl-consignee" placeholder="Consignee" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="pl-invoice-no" placeholder="Commercial Invoice Number" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="pl-ucr" placeholder="UCR Number" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="pl-custom-code" placeholder="Exporter's Custom Code" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="pl-vat" placeholder="VAT Number" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="pl-origin" placeholder="Country of Origin" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="pl-order-no" placeholder="Customer Order Number" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="pl-payment-terms" placeholder="Terms of Payment" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="pl-delivery-terms" placeholder="Terms of Delivery" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="pl-currency" placeholder="Currency" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                </div>
                <h3 class="text-xl font-semibold mt-8 mb-4 text-navy">Items</h3>
                <div id="pl-items-container" class="space-y-4">
                    <!-- Dynamic item rows will be added here -->
                </div>
                <button id="pl-add-item" class="mt-4 bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">+ Add Item</button>
            </div>

            <!-- Certificate of Conformance Form -->
            <div id="conformance-cert-form" class="form-section">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3 text-navy">Certificate of Conformance Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="text" id="cc-product-type" placeholder="Product Type" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="cc-batch-number" placeholder="Batch Number" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="cc-issue-date" placeholder="Date of Issue" class="p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500" onfocus="(this.type='date')" onblur="(this.type='text')">
                </div>
                <div class="mt-6">
                    <textarea id="cc-description" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500" placeholder="Description"></textarea>
                </div>
                <h3 class="text-xl font-semibold mt-8 mb-4 text-navy">Specifications</h3>
                <div id="cc-specs-container" class="space-y-4">
                    <!-- Dynamic spec rows will be added here -->
                </div>
                <button id="cc-add-spec" class="mt-4 bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">+ Add Specification</button>
                <div class="mt-6">
                    <input type="text" id="cc-remarks" placeholder="Remarks" class="w-full p-2 border rounded-md focus:ring-orange-500 focus:border-orange-500">
                    <input type="text" id="cc-issued-by" placeholder="C.O.C Issued by (Name of Issuer)" class="w-full p-2 border rounded-md mt-4 focus:ring-orange-500 focus:border-orange-500">
                </div>
            </div>

            <!-- Generate Button -->
            <div class="mt-10 text-center">
                <button id="generate-pdf" class="w-full md:w-auto btn-primary text-white font-bold py-3 px-12 rounded-lg focus:outline-none focus-ring-orange focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out text-lg">
                    Generate PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const { jsPDF } = window.jspdf;
            // --- Element Selectors ---
            const docTypeSelect = document.getElementById('doc-type');
            const packingListForm = document.getElementById('packing-list-form');
            const conformanceCertForm = document.getElementById('conformance-cert-form');
            const generatePdfBtn = document.getElementById('generate-pdf');
            const logoUpload = document.getElementById('logo-upload');
            const logoPreview = document.getElementById('logo-preview');
            const saveLogoBtn = document.getElementById('save-logo');

            // --- Hardcoded Data ---
            const hardcodedLetterhead = `Mohlalefi Engineering PTY Ltd\nReg No-2017/168379/07\n5A Union Road Roxton\nAlberton,Johannesburg\nSouth Africa`;
            const hardcodedBankingDetails = `Acc Holder- MOHLALEFI ENGINEERING PTY LTD\nBank - Standard Bank\nAcc No- 31 028 893 2\nBranch Code- 5937\nSwift Code- SBZAZAJJ`;

            let tempLogoDataUrl = null;

            // --- Load & Save Settings ---
            const savedLogo = localStorage.getItem('logoDataUrl');
            if (savedLogo) {
                logoPreview.src = savedLogo;
                tempLogoDataUrl = savedLogo;
            }

            saveLogoBtn.addEventListener('click', () => {
                if (tempLogoDataUrl) {
                    localStorage.setItem('logoDataUrl', tempLogoDataUrl);
                    alert('Logo saved!');
                } else {
                    alert('Please select a logo file first.');
                }
            });

            logoUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file && file.type === "image/png") {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        tempLogoDataUrl = e.target.result;
                        logoPreview.src = tempLogoDataUrl;
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert("Please upload a PNG file.");
                }
            });

            // --- Pre-fill Packing List Form ---
            const prefillPackingList = () => {
                const fields = {
                    'pl-consignee': 'Mine roof Engineering and Supplies',
                    'pl-vat': '4560280887',
                    'pl-origin': 'RSA',
                    'pl-payment-terms': 'Account',
                    'pl-delivery-terms': 'Ex Works-5A Union Road,Roxton',
                    'pl-currency': 'ZAR'
                };
                for (const [id, value] of Object.entries(fields)) {
                    const el = document.getElementById(id);
                    if (el) {
                        el.value = value;
                        el.readOnly = true;
                    }
                }
            };
            prefillPackingList();

            // --- Form Switching ---
            docTypeSelect.addEventListener('change', () => {
                packingListForm.classList.toggle('active', docTypeSelect.value === 'packing-list');
                conformanceCertForm.classList.toggle('active', docTypeSelect.value === 'conformance-cert');
            });

            // --- Dynamic Row Creation ---
            function createInputRow(container, placeholders) {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-1 md:grid-cols-6 gap-2 table-input-row items-center';
                placeholders.forEach(p => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = p;
                    input.className = 'p-2 border rounded-md col-span-1 focus:ring-orange-500 focus:border-orange-500';
                    if (p.toLowerCase() === 'description') {
                        input.className += ' md:col-span-2';
                    }
                    row.appendChild(input);
                });
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '✖';
                deleteBtn.className = 'bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs';
                deleteBtn.onclick = () => row.remove();

                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center justify-center';
                wrapper.appendChild(deleteBtn);
                row.appendChild(wrapper);

                container.appendChild(row);
            }

            // --- Initial Rows for Tables ---
            const plItemsContainer = document.getElementById('pl-items-container');
            document.getElementById('pl-add-item').addEventListener('click', () => createInputRow(plItemsContainer, ['Description', 'UOM', 'QTY', 'Weight', 'Packaging', 'Dimensions']));
            createInputRow(plItemsContainer, ['Description', 'UOM', 'QTY', 'Weight', 'Packaging', 'Dimensions']);

            const ccSpecsContainer = document.getElementById('cc-specs-container');
            document.getElementById('cc-add-spec').addEventListener('click', () => createInputRow(ccSpecsContainer, ['Specification', 'Min. Specification', 'Results']));
            createInputRow(ccSpecsContainer, ['Specification', 'Min. Specification', 'Results']);

            // --- Add Orange Footer to PDF ---
            const addFooter = (doc) => {
                const pageCount = doc.internal.getNumberOfPages();
                const today = new Date().toLocaleDateString();

                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);

                    doc.setFillColor(249, 115, 22); // Orange-500
                    doc.rect(0, doc.internal.pageSize.height - 10, doc.internal.pageSize.width, 10, 'F');

                    doc.setFontSize(8);
                    doc.setTextColor(255, 255, 255);
                    doc.text(today, 15, doc.internal.pageSize.height - 4);
                    const pageText = `Page ${i} of ${pageCount}`;
                    const textWidth = doc.getStringUnitWidth(pageText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                    doc.text(pageText, doc.internal.pageSize.width - 15 - textWidth, doc.internal.pageSize.height - 4);
                }
            };

            // --- Main PDF Generation Logic ---
            function generatePDFWithLogo() {
                const doc = new jsPDF();
                const docType = docTypeSelect.value;
                const logoDataUrl = localStorage.getItem('logoDataUrl');

                if (logoDataUrl) {
                    try {
                        doc.addImage(logoDataUrl, 'PNG', 15, 12, 50, 20);
                    } catch (e) {
                        console.error("Error adding logo from storage:", e);
                    }
                } else {
                    console.warn("No saved logo found. PDF will be generated without a logo.");
                }

                doc.setFontSize(9);
                doc.text(hardcodedLetterhead, 130, 15);

                // Orange Header Bar
                doc.setFillColor(249, 115, 22); // Orange-500
                doc.rect(0, 35, doc.internal.pageSize.width, 5, 'F');

                if (docType === 'packing-list') {
                    generatePackingList(doc);
                } else {
                    generateConformanceCert(doc);
                }
            }

            generatePdfBtn.addEventListener('click', generatePDFWithLogo);


            // --- Packing List PDF ---
            function generatePackingList(doc) {
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Packing List', 15, 50);

                // Details Section
                doc.setFontSize(10);
                const consignee = document.getElementById('pl-consignee').value;
                doc.setFont(undefined, 'bold');
                doc.text('Consignee:', 15, 60);
                doc.setFont(undefined, 'normal');
                doc.text(consignee, 15, 65, { maxWidth: 80 });

                const details = [
                    { label: 'Commercial Invoice Number:', value: document.getElementById('pl-invoice-no').value },
                    { label: 'UCR Number:', value: document.getElementById('pl-ucr').value },
                    { label: "Exporter's Custom Code:", value: document.getElementById('pl-custom-code').value },
                    { label: 'VAT Number:', value: document.getElementById('pl-vat').value },
                ];
                let detailY = 60;
                details.forEach(item => {
                    doc.setFont(undefined, 'bold');
                    doc.text(item.label, 110, detailY);
                    doc.setFont(undefined, 'normal');
                    doc.text(item.value, 155, detailY);
                    detailY += 5;
                });

                doc.setLineWidth(0.2);
                doc.line(15, 85, 195, 85);

                const terms = [
                    { label: 'Country of Origin:', value: document.getElementById('pl-origin').value },
                    { label: 'Customer Order Number:', value: document.getElementById('pl-order-no').value },
                    { label: 'Terms of Payment:', value: document.getElementById('pl-payment-terms').value },
                    { label: 'Terms of Delivery:', value: document.getElementById('pl-delivery-terms').value },
                    { label: 'Currency:', value: document.getElementById('pl-currency').value },
                ];
                let termsY = 92;
                terms.forEach(item => {
                    doc.setFont(undefined, 'bold');
                    doc.text(item.label, 15, termsY);
                    doc.setFont(undefined, 'normal');
                    doc.text(item.value, 60, termsY);
                    termsY += 6;
                });

                // Items Table
                const itemRows = plItemsContainer.querySelectorAll('.table-input-row');
                const tableData = Array.from(itemRows).map(row => Array.from(row.querySelectorAll('input')).map(input => input.value));
                doc.autoTable({
                    startY: termsY + 5,
                    head: [['DESCRIPTION', 'UOM', 'QTY', 'WEIGHT', 'PACKAGING', 'DIMENSIONS']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 58, 138] }, // Navy Blue
                });

                // Banking Details Section
                if (hardcodedBankingDetails.trim() !== '') {
                    let finalY = doc.autoTable.previous.finalY;
                    let startY = finalY + 15;
                    if (startY > 270) {
                        doc.addPage();
                        startY = 20;
                    }

                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Banking Details', 15, startY);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(hardcodedBankingDetails, 15, startY + 7, { maxWidth: 180 });
                }

                addFooter(doc);
                doc.save('packing-list.pdf');
            }

            // --- Certificate of Conformance PDF ---
            function generateConformanceCert(doc) {
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Certificate of Conformance', 105, 50, { align: 'center' });

                // Details Section
                doc.setFontSize(10);
                const details = [
                    { label: 'Product Type:', value: document.getElementById('cc-product-type').value },
                    { label: 'Description:', value: document.getElementById('cc-description').value },
                    { label: 'Batch Number:', value: document.getElementById('cc-batch-number').value },
                    { label: 'Date of Issue:', value: document.getElementById('cc-issue-date').value },
                ];
                let detailY = 65;
                details.forEach(item => {
                    doc.setFont(undefined, 'bold');
                    doc.text(item.label, 15, detailY);
                    doc.setFont(undefined, 'normal');
                    doc.text(item.value, 50, detailY, { maxWidth: 145 });
                    detailY += (item.label === 'Description:' ? 15 : 7);
                });

                // Specifications Table
                const specRows = ccSpecsContainer.querySelectorAll('.table-input-row');
                const tableData = Array.from(specRows).map(row => Array.from(row.querySelectorAll('input')).map(input => input.value));
                doc.autoTable({
                    startY: detailY + 5,
                    head: [['Specification', 'Minimum Specification / Customer Requirements', 'Results']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 58, 138] }, // Navy Blue
                });

                // Footer Section
                let finalY = doc.autoTable.previous.finalY;
                if (finalY > 230) {
                    doc.addPage();
                    finalY = 20;
                } else {
                    finalY += 15;
                }

                const remarks = document.getElementById('cc-remarks').value;
                doc.setFont(undefined, 'bold');
                doc.text('Remarks:', 15, finalY);
                doc.setFont(undefined, 'normal');
                doc.text(remarks, 35, finalY);

                finalY += 10;
                doc.text('This certifies that the Products supplied conform to the applicable required specifications.', 15, finalY);

                let signatureY = finalY + 25;
                const issuedBy = document.getElementById('cc-issued-by').value;

                // Left Side: Issuer and Signature
                doc.setFont(undefined, 'bold');
                doc.text('Issued by:', 15, signatureY);
                doc.setFont(undefined, 'normal');
                doc.text(issuedBy, 15, signatureY + 7);
                doc.setLineWidth(0.3);
                doc.line(15, signatureY + 20, 85, signatureY + 20); // Signature line
                doc.text('Signature', 15, signatureY + 25);

                // Right Side: Stamp Box
                doc.setLineWidth(0.2);
                doc.rect(145, signatureY - 5, 50, 30); // x, y, width, height
                doc.setTextColor(150);
                doc.text('Stamp', 162, signatureY + 12);
                doc.setTextColor(0);

                addFooter(doc);
                doc.save('certificate-of-conformance.pdf');
            }
        });
    </script>
</body>
</html>
